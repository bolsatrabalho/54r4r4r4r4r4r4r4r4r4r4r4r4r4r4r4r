<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Frequ√™ncia de Bolsistas</title>

<style>
body { font-family: Arial; background:#f4f6f8; padding:20px }
.container { background:#fff; padding:20px; border-radius:8px }
table { width:100%; border-collapse:collapse; font-size:12px }
th,td { border:1px solid #ccc; padding:6px; text-align:center }
th { background:#eee }
button { padding:6px 10px; margin:4px; cursor:pointer }
.hidden { display:none }
select,input { width:100%; font-size:12px }
.msg { margin:10px 0; color:green; font-weight:bold }
</style>
</head>

<body>
<div class="container">

<h2>Sistema de Frequ√™ncia</h2>
<div id="info"></div>
<div class="msg" id="msg"></div>

<button id="btnAdd" onclick="adicionar()">‚ûï Adicionar Bolsista</button>
<button onclick="salvar()">üíæ Salvar</button>

<table>
<thead>
<tr>
<th>Campus</th>
<th>Nome</th>
<th>Matr√≠cula</th>
<th>Setor</th>
<th>In√≠cio</th>
<th>Fim</th>
<th>Email Coord.</th>
<th>Jan</th><th>Fev</th><th>Mar</th><th>Abr</th>
<th>Mai</th><th>Jun</th><th>Jul</th><th>Ago</th>
<th>Set</th><th>Out</th><th>Nov</th><th>Dez</th>
<th>Justificativa</th>
<th>Arquivo</th>
<th>A√ß√µes</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

</div>

<script>
const URL = "https://script.google.com/macros/s/AKfycby8WClrNiXfAiMv9B-9Tcu7fGMd8d-eVKigqEcd-ueq2DwRH-5tNrleTxXq-whAgwjxBA/exec";
const EMAIL_ADMIN = "bolsatrabalho@prex.uespi.br";

const email = sessionStorage.getItem("coordenadorLogado");
if (!email) location.href = "index.html";

const tipo = email === EMAIL_ADMIN ? "admin" : "coord";
document.getElementById("info").innerText =
  `Usu√°rio: ${email} | Perfil: ${tipo}`;

if (tipo !== "admin") document.getElementById("btnAdd").classList.add("hidden");

let dados = [];

fetch(`${URL}?acao=listar&email=${email}`)
.then(r=>r.json())
.then(j=>{
  dados = j.dados;
  render();
})
.catch(()=>alert("Erro ao carregar dados"));

function render(){
  const tb=document.getElementById("tbody");
  tb.innerHTML="";
  dados.forEach((l,i)=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
<td>${campo(l[0],i,0)}</td>
<td>${campo(l[1],i,1)}</td>
<td>${campo(l[2],i,2)}</td>
<td>${campo(l[3],i,3)}</td>
<td>${campoData(l[4],i,4)}</td>
<td>${campoData(l[5],i,5)}</td>
<td>${campo(l[6],i,6)}</td>
${mes(i,7)}${mes(i,8)}${mes(i,9)}${mes(i,10)}
${mes(i,11)}${mes(i,12)}${mes(i,13)}${mes(i,14)}
${mes(i,15)}${mes(i,16)}${mes(i,17)}${mes(i,18)}
<td><input value="${l[19]||""}" onchange="dados[${i}][19]=this.value"></td>
<td><input type="file" onchange="arquivo(event,${i})"></td>
<td>${tipo==="admin"?`<button onclick="remover(${i})">‚ùå</button>`:""}</td>`;
    tb.appendChild(tr);
  });
}

function campo(v,i,c){
  if(tipo==="admin")
    return `<input value="${v||""}" onchange="dados[${i}][${c}]=this.value">`;
  return v||"";
}

function campoData(v,i,c){
  if(tipo==="admin")
    return `<input type="date" value="${v||""}" onchange="dados[${i}][${c}]=this.value">`;
  return v||"";
}

function mes(i,c){
  return `<td>
<select onchange="dados[${i}][${c}]=this.value">
<option value=""></option>
<option ${dados[i][c]==="SIM"?"selected":""}>SIM</option>
<option ${dados[i][c]==="N√ÉO"?"selected":""}>N√ÉO</option>
</select>
</td>`;
}

function adicionar(){
  dados.push(["","","","","","","","","","","","","","","","","","","",""]);
  render();
}

function remover(i){
  if(confirm("Remover bolsista?")){
    dados.splice(i,1);
    render();
  }
}

function arquivo(e,i){
  const f=e.target.files[0];
  if(!f) return;
  if(f.size>10*1024*1024){ alert("M√°x 10MB"); return;}
  const r=new FileReader();
  r.onload=()=>dados[i].arquivo={
    nome:f.name,
    tipo:f.type,
    base64:r.result.split(",")[1]
  };
  r.readAsDataURL(f);
}

function salvar(){
  Promise.all(dados.map(b=>{
    if(!b[2]) return;
    return fetch(URL,{
      method:"POST",
      body:JSON.stringify({
        matricula:b[2],
        mes:"FREQUENCIA",
        presenca:b.slice(7,19),
        justificativa:b[19],
        nomeArquivo:b.arquivo?.nome,
        tipoArquivo:b.arquivo?.tipo,
        arquivoBase64:b.arquivo?.base64
      })
    });
  })).then(()=>{
    document.getElementById("msg").innerText="Dados salvos com sucesso ‚úî";
  });
}
</script>
</body>
</html>
